#!/bin/bash

set -euo pipefail

get_latest_release() {
  curl -s https://api.github.com/repos/"$1"/releases/latest | grep "tag_name" | cut -d '"' -f 4 | cat
}

mkdir -p ~/.local/bin

curl -L https://github.com/rust-lang/rust-analyzer/releases/download/nightly/rust-analyzer-aarch64-apple-darwin.gz | \
  gunzip -c - > ~/.local/bin/rust-analyzer && \
  chmod +x ~/.local/bin/rust-analyzer

latest_release=$(get_latest_release "elixir-lsp/elixir-ls")
mkdir -p ~/.local/bin/elixir-ls && \
  curl -L https://github.com/elixir-lsp/elixir-ls/releases/download/v"$latest_release"/elixir-ls-v"$latest_release".zip | \
  tar -xf - -C ~/.local/bin/elixir-ls - && \
  chmod +x ~/.local/bin/elixir-ls/*.sh

latest_release=$(get_latest_release "tekumara/typos-vscode")
curl -L https://github.com/tekumara/typos-vscode/releases/download/v"$latest_release"/typos-lsp-v"$latest_release"/-aarch64-apple-darwin.tar.gz | \
  tar -xzsf - -C ~/.local/bin/typos-lsp && \
  chmod +x ~/.local/bin/typos-lsp

curl -L https://github.com/tamasfe/taplo/releases/latest/download/taplo-darwin-aarch64.gz | \
  gunzip -c - > ~/.local/bin/taplo && \
  chmod +x ~/.local/bin/taplo

curl -L https://github.com/mrjosh/helm-ls/releases/latest/download/helm_ls_darwin_amd64 --output ~/.local/bin/helm_ls && \
  chmod +x ~/.local/bin/helm_ls

brew install hadolint
brew install hashicorp/tap/terraform-ls
brew install marksman
brew install shellcheck

composer require --dev phpactor/phpactor
composer require --dev friendsofphp/php-cs-fixer
composer require --dev vimeo/psalm

npm install --save-dev \
  @commitlint/{cli,config-conventional} \
  @elm-tooling/elm-language-server \
  @microsoft/compose-language-service \
  bash-language-server \
  dockerfile-language-server-nodejs \
  graphql-language-service-cli \
  prettier \
  sql-language-server \
  vscode-html-languageservice \
  vscode-json-languageservice \
  vscode-langservers-extracted \
  yaml-language-server

pip install \
  ruff \
  ruff-lsp

rtx use -g lua-language-server@latest
