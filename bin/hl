#!/bin/bash

sk_matches=$(
  sk --multi --height 12 --ansi --interactive \
    --cmd 'rg --color=always --line-number --no-heading "{}"' \
    --preview \
      'bat \
        --color=always \
        --style=numbers \
        --highlight-line "$(echo {1} | cut -d: -f2)" "$(echo {1} | cut -d: -f1)"
      '
)

file_paths=""
while read sk_match; do
  file_path=$(echo "$sk_match" | cut -d: -f1 | sed -e "s/ /\\\ /g") 
  if [ -z "$file_path" ]; then
    break
  fi 
  line_number=$(echo "$sk_match" | cut -d: -f2)
  file_paths+=" $file_path:$line_number"
done <<< "$sk_matches"

if [[ -n "$file_paths" ]]; then
  helix_pane_id=$(wezterm cli get-pane-direction Right)
  wezterm cli send-text --pane-id "$helix_pane_id" --no-paste ":"
  wezterm cli send-text --pane-id "$helix_pane_id" "open $file_paths"
  printf "\r" | wezterm cli send-text --pane-id "$helix_pane_id" --no-paste
  wezterm cli activate-pane --pane-id "$helix_pane_id"
fi
