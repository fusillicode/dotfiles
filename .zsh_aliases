# General
alias nv='nvim'
alias code='code-insiders'
alias l='ls -llAtrh'
alias j='jq . -c'
alias jl='jq . '
function sorce() { set -a && source "$@" && set +a; }
function h() { fc -lnir 1; }

# Git
alias g='git'
alias gaa='git add --all'
alias grhh='git reset --hard HEAD'
alias gco='git checkout'
alias gc='git commit --verbose'
alias gb='git branch'
alias gba='git branch -a'
alias gst='git status'
alias gp='git push'
alias gcnoke='git commit --amend --no-edit --no-verify --allow-empty'
alias gcnuke='git commit --amend --no-edit --no-verify --allow-empty && git push --force-with-lease'
alias gbrr='git for-each-ref --sort=committerdate refs/heads/ --format="%(HEAD) %(color:yellow)%(refname:short)%(color:reset) %(color:red)%(objectname:short)%(color:reset) - %(contents:subject) %(color:green)(%(committerdate:relative))%(color:reset) %(color:blue)<%(authorname)>%(color:reset)"'
alias gdh='git diff HEAD~1'
alias gfp='git fetch --all --prune && git pull origin "$(git branch --show-current)"'
function gtnuke() {
  [[ -z "$1" ]] && { echo "Usage: gtnuke <tag>"; return 1; }
  echo "Force-push tag '$1'? [y/N] " && read -q && echo && \
    git tag -f "$1" && git push origin "$1" -f
}
function gm() { git commit -m "$*"; }
function gmm() { git commit --amend -m "$*"; }
function glod() { git --no-pager log --graph --pretty="%Cred%h%Creset%C(auto)%d%Creset %s %Cgreen(%ad) %C(bold blue)%an <%ae>%Creset" -n "${1:-7}"; }

# Kubernetes
alias k='kubectl'
alias kdebian='kubectl exec -it debian -- bash || kubectl run debian --image=debian:latest --rm -it --restart=Never --command --'
function klfir() {
  [[ -z "$1" ]] && { echo "Usage: klfir <pod-pattern> [container]"; return 1; }
  kubectl get pods | rg "$1" | head -n 1 | rg "^(\S*).*" -r '$1' | xargs -I {} kubectl logs -f {} "${2:-}"
}
function kseclist() { kubectl get secrets -oname ${1:+--namespace="$1"}; }
function ksecyaml() {
  [[ -z "$1" ]] && { echo "Usage: ksecyaml <secret-pattern> [namespace]"; return 1; }
  kubectl get secrets -oname ${2:+--namespace="$2"} | rg "secret/(.*$1.*)" -r '$1' | xargs -I {} kubectl get secret {} -oyaml
}
function kcronsus() {
  [[ -z "$1" || -z "$2" ]] && { echo "Usage: kcronsus <cronjob> <true|false>"; return 1; }
  kubectl patch cronjobs "$1" --patch '{"spec": {"suspend": '"$2"'}}'
}
function kdeplscale() {
  [[ -z "$1" || -z "$2" ]] && { echo "Usage: kdeplscale <deployment> <replicas>"; return 1; }
  kubectl patch deployment "$1" --patch '{"spec": {"replicas": '"$2"'}}'
}
function kdelerrpod() { kubectl get pods | rg "(\S+).*Error.*" -r '$1' | xargs -I {} kubectl delete pod {}; }
function ksecdec() {
  [[ -z "$1" || -z "$2" ]] && { echo "Usage: ksecdec <key-pattern> <secret-pattern> [namespace]"; return 1; }
  kubectl get secrets -oname ${3:+--namespace="$3"} | \
    rg "secret/(.*$2.*)" -r '$1' | xargs -I {} kubectl get secret {} -oyaml | \
    rg "\s+(.*$1.*):\s+(.*)" -r '$1:$2' | \
    while read -r kv; do
      dv=$(echo "$kv" | rg ".*:(.*)" -r '$1' | base64 -D)
      k=$(echo "$kv" | rg "(.*):.*" -r '$1')
      echo "$k" "$dv"
    done
}
function kcronrest() {
  [[ -z "$1" ]] && { echo "Usage: kcronrest <cronjob> [namespace]"; return 1; }
  local maybe_namespace="${2:+--namespace=$2}"
  local tmpfile=$(mktemp)
  trap "rm -f '$tmpfile'" EXIT
  kubectl get cronjobs "$1" $maybe_namespace -oyaml | \
    kubectl apply --dry-run=client -oyaml -f - > "$tmpfile"
  kubectl delete cronjobs "$1" $maybe_namespace --ignore-not-found
  kubectl apply $maybe_namespace -f "$tmpfile"
}

# PostgreSQL
function pg_copy_table() { pg_dump -a -t "$1" "$2" | psql "$3"; }

# Docker
alias dps='docker ps'

# Cargo/Rust
alias carbo='cargo'
alias cmc='cargo make clippy'
alias cmch='cargo make check'
alias cmdr='cargo make db-reset'
alias cmdp='cargo make db-prepare'
alias cmdm='cargo make db-migrate'
alias cmf='cargo make format'
alias cmr='cargo make run'
alias ccc='cargo clippy'
alias cfm='cargo fmt'
function cmt() { cargo make test "$*"; }
function ct() { cargo test "$*"; }
function cnt() { cargo nextest run "$*"; }
function ctn() { cargo nextest run "$*"; }
