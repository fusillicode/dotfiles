#!/usr/bin/env bash
# pre-push (tracked version) - runs the `tec` binary (cargo-machete + cargo-sort wrapper)
# to validate the Rust workspace before allowing a push.
#
# Place this in a tracked hooks directory (.githooks/) and configure:
#   git config core.hooksPath .githooks
# so Git uses this instead of .git/hooks/.
#
# Exits nonâ€‘zero to block the push if checks fail.

set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
workspace_dir="$repo_root/yog"
tec_bin="$workspace_dir/target/release/tec"

cargo build --release --quiet --manifest-path "$workspace_dir/Cargo.toml" --bin tec || {
  echo "[pre-push] Build tec failed." >&2
  exit 1
}

if ! "$tec_bin" "$workspace_dir"; then
  echo "[pre-push] Checks failed. Push blocked." >&2
  exit 1
fi

echo "[pre-push] All checks passed. Proceeding with push."
exit 0
